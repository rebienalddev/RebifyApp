<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rebify</title>
    <style>
        /* --- CSS Variables and Global Styles (Black & White Theme) --- */
        :root {
            --primary-pink: #000000; /* Primary Black (Main CTA, Selected) */
            --primary-dark: #000000; /* Primary Black (Headings, Text Contrast) */
            --heading-color: #000000; 
            --bg-light: #f4f4f4; /* Light Gray (Page Background) */
            --bg-lighter: #ffffff; /* White (Main Content Area) */
            --text-color: #000000; /* Black for readability */
            --border-color: #000000; /* Black (Input borders, dividers) */
            --success-color: #00b894; /* Bright Green */
            --error-color: #ff6b81; /* Soft Red */
            --white: #ffffff;
            /* Square, offset shadow for retro/cute effect */
            --shadow-lg: 4px 4px 0px 0px rgba(0, 0, 0, 0.3); 
            --shadow-sm: 2px 2px 0px 0px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            padding: 0;
            margin: 0;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
        }

        /* --- Layout & Structure --- */
        header {
            text-align: center;
            margin-bottom: 2.5rem;
            padding: 1.5rem;
            background-color: var(--bg-lighter);
            border: 3px solid var(--primary-dark); /* Thick main border */
            box-shadow: var(--shadow-lg);
        }

        main {
            background-color: var(--bg-lighter);
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-lg);
        }
        
        /* Mobile-first padding adjustment */
        @media (min-width: 640px) {
            main {
                padding: 2.5rem;
            }
        }

        /* --- Typography & Headings --- */
        h1 {
            font-size: 2.5rem;
            font-weight: 900;
            color: var(--primary-dark);
            line-height: 1.2;
            text-shadow: 1px 1px 0 var(--border-color); /* Subtle text shadow */
        }

        h2 {
            font-size: 1.875rem;
            font-weight: 800;
            color: var(--heading-color);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary-pink); /* Pink underline */
        }

        .subtitle {
            color: var(--primary-pink);
            margin-top: 0.5rem;
            font-size: 1rem;
        }

        /* --- Forms & Inputs --- */
        .input-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-size: 0.875rem;
            font-weight: 700; /* Made bolder */
            color: var(--primary-dark);
            margin-bottom: 0.5rem;
        }

        .input-field,
        select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--primary-dark); /* Thicker input border */
            box-shadow: var(--shadow-sm);
            background-color: var(--white);
            color: var(--text-color);
            resize: none;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            box-sizing: border-box; 
        }
        
        .input-field:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-pink);
            box-shadow: 0 0 0 2px var(--primary-pink);
        }
        
        .input-field[disabled] {
            background-color: var(--bg-light);
            opacity: 0.8;
            cursor: not-allowed;
            box-shadow: none;
            border: 1px solid var(--border-color);
        }
        
        /* Custom File Upload Styling (FIXED FOR RESPONSIVENESS) */
        .custom-file-upload input[type="file"] {
            display: none; /* Hide the native input */
        }

        .upload-btn-style {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            background-color: var(--bg-light); 
            color: var(--primary-dark);
            padding: 0.75rem 1rem;
            width: 100%; 
            border: 2px solid var(--primary-dark);
            box-shadow: var(--shadow-sm);
            justify-content: flex-start; /* Align content left */
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.1s;
            box-sizing: border-box; /* IMPORTANT FIX */
        }
        
        .upload-btn-style:hover {
            background-color: #e0e0e0;
            box-shadow: 3px 3px 0px 0px var(--primary-dark);
            transform: translate(-1px, -1px);
        }

        /* --- Buttons (Styled for Square/Cute/Interactive) --- */
        .btn {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0.75rem 1rem;
            border: none;
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--white);
            cursor: pointer;
            transition: all 0.1s;
            border: 2px solid var(--primary-dark);
            box-shadow: 3px 3px 0px 0px var(--primary-dark); /* Cute lift effect */
        }
        
        .btn:hover {
            transform: translate(-1px, -1px); /* Moves up and left */
            box-shadow: 4px 4px 0px 0px var(--primary-dark);
        }

        .btn-primary {
            background-color: var(--primary-pink);
        }

        .btn-primary:hover {
            background-color: #333333; /* Dark gray on hover */
        }

        .btn-success {
            background-color: var(--success-color);
            border-color: #065c49;
            box-shadow: 3px 3px 0px 0px #065c49;
        }

        .btn-success:hover {
            background-color: #00cc99;
        }

        .btn-secondary {
            background-color: var(--bg-light);
            color: var(--primary-dark);
            border: 1px solid var(--border-color);
            box-shadow: none;
            font-size: 0.875rem;
            padding: 0.5rem 1.5rem;
            border: 1px solid var(--primary-dark);
            box-shadow: 2px 2px 0px 0px var(--primary-dark);
        }
        
        .btn-secondary:hover {
            background-color: #e0e0e0;
            transform: translate(-1px, -1px);
            box-shadow: 3px 3px 0px 0px var(--primary-dark);
        }

        .btn:disabled,
        .btn-disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none !important;
            border: 1px solid #9ca3af;
        }

        /* --- Grid Layouts (Responsive) --- */
        .config-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
        
        @media (min-width: 768px) {
            .config-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* --- Loading Spinner --- */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 20rem;
        }
        
        .spinner {
            animation: spin 1s linear infinite;
            height: 2.5rem;
            width: 2.5rem;
            color: var(--primary-pink);
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* --- Quiz Specific --- */
        .quiz-option {
            width: 100%;
            text-align: left;
            padding: 1rem;
            border: 2px solid var(--primary-dark); /* Stronger border */
            background-color: var(--white);
            transition: all 0.15s ease-in-out;
            font-weight: 500;
            cursor: pointer;
            box-sizing: border-box;
            box-shadow: var(--shadow-sm);
        }

        .quiz-option:hover {
            background-color: var(--bg-light);
            border-color: var(--primary-pink);
            box-shadow: 3px 3px 0px 0px rgba(0, 0, 0, 0.3);
        }

        .quiz-option.selected {
            background-color: var(--primary-pink);
            border-color: var(--primary-dark);
            color: var(--white);
            box-shadow: 4px 4px 0px 0px var(--primary-dark);
        }
        
        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--primary-dark);
            padding-bottom: 0.5rem;
        }

        .quiz-type-tag {
            font-size: 0.875rem;
            background-color: var(--primary-pink); /* Tag uses solid pink */
            padding: 0.25rem 0.75rem;
            font-weight: 600;
            text-transform: uppercase; /* More punchy */
            color: var(--white);
            border: 1px solid var(--primary-dark);
        }

        .quiz-question-box {
            padding: 1.5rem;
            background-color: var(--bg-lighter);
            border: 3px solid var(--primary-pink); /* Highlighted question box */
            font-size: 1.25rem;
            font-weight: 500;
            color: var(--text-color);
            line-height: 1.6;
            margin-bottom: 1.5rem;
            box-shadow: 5px 5px 0px 0px rgba(0, 0, 0, 0.5); /* Stronger question shadow */
        }

        .quiz-nav {
            display: flex;
            justify-content: space-between;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }
        
        /* --- Results Screen --- */
        .results-summary {
            text-align: center;
            padding: 2rem;
            background-color: var(--bg-light); /* Soft background */
            border: 3px solid var(--primary-dark);
            box-shadow: var(--shadow-lg);
            border-bottom: 6px solid var(--primary-pink);
        }
        
        .results-score {
            font-size: 3.75rem;
            font-weight: 900;
            color: var(--primary-pink);
            margin: 1rem 0;
            text-shadow: 2px 2px 0 var(--primary-dark);
        }

        .feedback-box {
            padding: 1.5rem;
            background-color: var(--bg-lighter);
            border: 2px solid var(--success-color);
            border-left: 8px solid var(--success-color); /* Highlight for AI */
            margin-top: 2rem;
            box-shadow: 4px 4px 0px 0px rgba(0, 184, 148, 0.2);
        }
        
        .feedback-box h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--heading-color);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
        }
        
        .review-item {
            padding: 1rem;
            border: 1px solid #e0e0e0;
            margin-bottom: 1.5rem;
            box-shadow: 2px 2px 0px 0px rgba(0, 0, 0, 0.1);
        }

        .review-item.correct {
            background-color: #ecfdf5; /* light green */
            border-left: 6px solid var(--success-color);
        }

        .review-item.incorrect {
            background-color: #fee2e2; /* light red */
            border-left: 6px solid var(--error-color);
        }

        .review-answer-correct {
            color: #065f46; /* dark green */
            font-weight: 700;
        }

        .review-answer-incorrect {
            color: #991b1b; /* dark red */
            font-weight: 700;
        }

        .review-question {
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 0.5rem;
        }
        
        /* --- Modal Styling --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        
        .modal-content {
            background-color: var(--white);
            padding: 1.5rem;
            box-shadow: var(--shadow-lg);
            max-width: 384px;
            margin: 0 auto;
            border: 2px solid var(--primary-dark);
        }
        
        .modal-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 0.75rem;
        }

        /* --- Sidebar Navigation --- */
        .app-layout {
            display: flex;
            height: 100vh;
            width: 100%;
        }

        .sidebar {
            width: 260px;
            background-color: var(--bg-lighter);
            border-right: 3px solid var(--primary-dark);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-brand {
            font-size: 1.75rem;
            font-weight: 900;
            color: var(--primary-dark);
            margin-bottom: 2.5rem;
            text-transform: uppercase;
            letter-spacing: -0.05em;
        }

        .nav-menu {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .nav-item {
            width: 100%;
            text-align: left;
            padding: 1rem;
            background: transparent;
            border: 2px solid transparent;
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.2s;
            box-sizing: border-box;
        }

        .nav-item:hover {
            background-color: var(--bg-light);
            border-color: var(--primary-dark);
            box-shadow: var(--shadow-sm);
            transform: translate(-2px, -2px);
        }

        .nav-item.active {
            background-color: var(--primary-dark);
            color: var(--white);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-dark);
        }

        .main-content-wrapper {
            flex: 1;
            height: 100%;
            overflow-y: auto;
            padding: 2rem;
        }
        
        /* Hamburger Button */
        .hamburger-btn {
            display: none;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--primary-dark);
            padding: 0.5rem;
            margin-right: 1rem;
        }

        @media (max-width: 768px) {
            .app-layout {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 3px solid var(--primary-dark);
                padding: 1rem;
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
                position: relative;
                z-index: 50;
            }
            .sidebar-brand {
                margin-bottom: 0;
                font-size: 1.5rem;
            }
            .hamburger-btn {
                display: block;
            }
            .nav-menu {
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                width: 100%;
                background-color: var(--bg-lighter);
                border-bottom: 3px solid var(--primary-dark);
                flex-direction: column;
                padding: 1rem;
                box-shadow: var(--shadow-lg);
                box-sizing: border-box;
                gap: 1rem;
            }
            .nav-menu.show {
                display: flex;
            }
            .nav-item {
                padding: 1rem;
                font-size: 1rem;
                text-align: center;
            }
            .main-content-wrapper {
                height: 100%;
                padding: 1rem;
            }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="app-layout">
        <nav class="sidebar">
            <div class="sidebar-brand">
                Reb Dev
                </div>
            <button class="hamburger-btn" id="mobile-menu-btn" aria-label="Toggle menu">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>
            <ul class="nav-menu">
                <li><button class="nav-item active" onclick="location.reload()">1. Multiple Items</button></li>
                <li><button class="nav-item" onclick="window.location.href='flashcard.html'">2. Flash Card</button></li>
                <li><button class="nav-item" onclick="window.location.href='identification.html'">3. Identification</button></li>
            </ul>
        </nav>
        
        <div class="main-content-wrapper">
            <div class="container">
                <header>
                    <h1 class="leading-tight">
                    Rebify
                    </h1>
                   
                </header>
                
                <main id="app-main">
                    <!-- Content will be rendered here by JavaScript -->
                </main>
            </div>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script type="module">
        import { apiKey } from './config.js';
        // --- Global Constants ---
        const MODEL_NAME = 'gemini-2.5-flash';

        // --- Anti-Inspection Logic ---
        document.addEventListener('contextmenu', event => event.preventDefault());
        document.addEventListener('keydown', event => {
            if (
                event.key === 'F12' ||
                (event.ctrlKey && event.shiftKey && (event.key === 'I' || event.key === 'J' || event.key === 'C')) ||
                (event.ctrlKey && event.key === 'u')
            ) {
                event.preventDefault();
            }
        });

        // --- Mobile Menu Logic ---
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const navMenu = document.querySelector('.nav-menu');
        if (mobileMenuBtn) {
            mobileMenuBtn.addEventListener('click', () => {
                navMenu.classList.toggle('show');
            });
        }

        // --- Application State ---
        let userId = null; 
        let fileContentText = ''; // Manually pasted content
        let fileDataBase64 = null; // Base64 content of uploaded file
        let fileMimeType = null; // Mime type of uploaded file
        let pdfFileName = ''; // Display name
        
        let quizConfig = {
            numQuestions: 5,
            difficulty: 'Medium',
            type: 'multiple-choice',
        };

        let quizStatus = 'config'; // 'config', 'loading', 'quiz', 'results'
        let questions = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let score = 0;
        let feedback = '';
        let loadingMessage = '';
        let error = null;
        
        const mainElement = document.getElementById('app-main');

        // --- Utility Functions ---
        
        /**
         * Simple UUID generator for user identification.
         */
        function generateUUID() {
             return 'xxxx-xxxx-4xxx-yxxx-xxxx'.replace(/[xy]/g, function(c) {
                 var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                 return v.toString(16);
             });
        }

        /**
         * Retries a fetch request with exponential backoff.
         */
        async function fetchWithRetry(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        console.error("Max retries reached. Failing request.", error);
                        throw error;
                    }
                }
            }
        }

        /**
         * Calls the Gemini API for question generation.
         */
        async function generateQuizContent() {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;

            // *** REVISED SYSTEM PROMPT FOR BETTER QUALITY AND GROUNDING ***
            const systemPrompt = `You are a highly analytical and extremely strict Quiz Master AI. Your primary task is to generate high-quality, relevant quiz questions and answers based *ONLY* on the provided CONTENT.

            INSTRUCTIONS:
            1. The questions MUST be directly derivable from the CONTENT provided in the user query. Do not use outside knowledge.
            2. The output MUST be a JSON array of ${quizConfig.numQuestions} question objects, strictly matching the provided schema. Do NOT include any text outside the JSON block.
            3. The difficulty must be ${quizConfig.difficulty}.
            4. Question type is ${quizConfig.type}.
            5. For 'multiple-choice', generate exactly 4 plausible options, with the correct answer being one of them. The correct answer must also be explicitly listed in the 'answer' field.
            6. For 'identification' and 'enumeration', the 'options' field must be an empty array []. The 'answer' field MUST contain the single, most precise correct response (e.g., a short phrase or comma-separated list).
            `;

            const responseSchema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        "question": { "type": "STRING", "description": "The quiz question." },
                        "options": { "type": "ARRAY", "items": { "type": "STRING" }, "description": "Exactly 4 options for multiple choice, empty array for others." },
                        "answer": { "type": "STRING", "description": "The single, correct answer string." },
                        "type": { "type": "STRING", "description": "The type of question (e.g., 'multiple-choice')." }
                    },
                    propertyOrdering: ["question", "options", "answer", "type"]
                }
            };
            
            let contentsParts = [];
            let userQueryBase = `Generate a quiz with ${quizConfig.numQuestions} questions of ${quizConfig.difficulty} difficulty, and ${quizConfig.type} type, based on the following CONTENT:`;

            if (fileDataBase64 && fileMimeType) {
                // Multimodal input (PDF/file)
                contentsParts.push({ text: userQueryBase });
                contentsParts.push({
                    inlineData: {
                        mimeType: fileMimeType,
                        data: fileDataBase64
                    }
                });
            } else if (fileContentText.trim()) {
                // Text input
                contentsParts.push({ text: `${userQueryBase} "${fileContentText.substring(0, 5000)}"` });
            } else {
                throw new Error("No content uploaded or pasted.");
            }

            const payload = {
                contents: [{ parts: contentsParts }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema,
                }
            };


            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            const response = await fetchWithRetry(apiUrl, options);
            const result = await response.json();

            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                const jsonString = result.candidates[0].content.parts[0].text;
                return JSON.parse(jsonString);
            } else {
                throw new Error("Failed to generate structured JSON response from AI.");
            }
        }

        /**
         * Calls the Gemini API for final feedback generation.
         */
        async function generateFeedback(correctCount, totalQuestions, finalAnswers) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;

            const systemPrompt = `You are a motivational and informative tutor. Based on the user's score and performance, provide concise, encouraging feedback and suggest one topic from the quiz content where the user could improve. Keep the response to 3-5 sentences.`;

            const performanceDetails = questions.map((q, index) => ({
                question: q.question,
                userAnswer: finalAnswers[index],
                correctAnswer: q.answer,
                isCorrect: finalAnswers[index] === q.answer // Simple comparison for feedback context
            }));

            const userQuery = `The user scored ${correctCount} out of ${totalQuestions}. Provide feedback based on the following performance details:\n${JSON.stringify(performanceDetails, null, 2)}`;

            const payload = {
                contents: [{ role: "user", parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            const response = await fetchWithRetry(apiUrl, options);
            const result = await response.json();

            return result.candidates?.[0]?.content?.parts?.[0]?.text || "Great job! Feedback generation failed, but your score speaks for itself.";
        }

        // --- Core Application Logic ---

        /**
         * Handles state changes and re-renders the UI.
         */
        function renderApp() {
            // Note: userIdDisplay element removed per user request
            
            switch (quizStatus) {
                case 'config':
                    renderConfigScreen();
                    break;
                case 'loading':
                    renderLoadingScreen();
                    break;
                case 'quiz':
                    renderQuizScreen();
                    break;
                case 'results':
                    renderResultsScreen();
                    break;
            }
        }

        // --- Screen Renderers ---

        function renderConfigScreen() {
            // Determine the content source status for display
            let contentSourceMessage = '';
            let contentReady = false;

            if (fileDataBase64 && pdfFileName) {
                contentSourceMessage = `Content Source: Uploaded file (${pdfFileName}). Ready to generate.`;
                contentReady = true;
            } else if (fileContentText.trim()) {
                contentSourceMessage = `Content Source: Pasted text (${fileContentText.length} chars). Ready to generate.`;
                contentReady = true;
            } else {
                contentSourceMessage = `Content Source: None. Upload a file or paste text below.`;
                contentReady = false;
            }

            mainElement.innerHTML = `
                <div class="space-y-6">
                    <h2>1. Upload Content</h2>
                    
                    <div class="input-group">
                        <label for="pdfFile" style="font-size: 1.125rem;">
                            Upload PDF / Text File (Content Source)
                        </label>
                        <p style="font-size: 0.875rem; color: #4b5563; margin-bottom: 0.75rem;">
                            Note: File upload is preferred for PDFs. Maximum file size is 4MB.
                        </p>
                        
                        <!-- Custom Styled File Input -->
                        <div class="custom-file-upload">
                            <input type="file" id="pdfFile" accept=".pdf, .txt" />
                            <label for="pdfFile" id="fileInputLabel" class="upload-btn-style">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="square" stroke-linejoin="miter" style="height: 1.25rem; width: 1.25rem;">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                    <line x1="12" y1="12" x2="12" y2="18"></line>
                                    <line x1="9" y1="15" x2="15" y2="15"></line>
                                </svg>
                                <span id="uploadFileName">${pdfFileName || 'Choose File...'}</span>
                            </label>
                        </div>
                        <!-- End Custom Styled File Input -->

                        <p id="contentSourceDisplay" style="margin-top: 0.5rem; font-size: 0.75rem; color: ${contentReady ? 'var(--success-color)' : 'var(--error-color)'}; font-weight: 600;">${contentSourceMessage}</p>
                    </div>

                    <div class="input-group">
                        <label for="quizText" style="font-size: 1.125rem;">
                            Pasted Content (Max 5000 chars)
                        </label>
                        <textarea
                            id="quizText"
                            rows="8"
                            class="input-field"
                            placeholder="Paste chapters, notes, or articles here. This content is used by the AI."
                            maxlength="5000"
                            ${(fileDataBase64 || pdfFileName) ? 'disabled' : ''}
                        >${fileContentText}</textarea>
                        <p id="charCount" style="text-align: right; font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">${fileContentText.length} / 5000</p>
                    </div>

                    <h2>2. Configure Quiz</h2>
                    
                    <div class="config-grid">
                        <div class="input-group">
                            <label for="numQuestions">
                                Number of Questions
                            </label>
                            <select id="numQuestions" name="numQuestions">
                                ${[3, 5, 10, 15].map(n => `<option value="${n}" ${quizConfig.numQuestions === n ? 'selected' : ''}>${n}</option>`).join('')}
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="difficulty">
                                Difficulty Level
                            </label>
                            <select id="difficulty" name="difficulty">
                                ${['Easy', 'Medium', 'Hard', 'Expert'].map(d => `<option value="${d}" ${quizConfig.difficulty === d ? 'selected' : ''}>${d}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    
                    <div style="padding-top: 1.5rem;">
                         <button
                            id="generateQuizButton"
                            class="btn btn-primary"
                            style="width: 100%;"
                            ${contentReady ? '' : 'disabled'}
                        >
                            Generate Quiz
                        </button>
                    </div>
                    ${error ? `<div style="padding: 0.75rem; margin-top: 1rem; background-color: #fee2e2; border: 1px solid #fca5a5; color: #991b1b; font-size: 0.875rem;">${error}</div>` : ''}
                </div>
            `;

            // Attach event listeners after rendering
            document.getElementById('quizText').addEventListener('input', handleTextChange);
            document.getElementById('pdfFile').addEventListener('change', handleFileChange);
            document.getElementById('numQuestions').addEventListener('change', handleConfigChange);
            document.getElementById('difficulty').addEventListener('change', handleConfigChange);
            document.getElementById('generateQuizButton').addEventListener('click', handleGenerateQuiz);
        }

        function renderLoadingScreen() {
            mainElement.innerHTML = `
                <div class="loading-container">
                    <svg class="spinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p style="margin-top: 1rem; font-size: 1.25rem; font-weight: 500; color: var(--primary-dark);">${loadingMessage}</p>
                    <p style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--primary-pink);">This might take a few moments as the AI reads the content.</p>
                </div>
            `;
        }

        function renderQuizScreen() {
            const q = questions[currentQuestionIndex];
            if (!q) {
                mainElement.innerHTML = '<p>No questions loaded.</p>';
                return;
            }

            const isMultipleChoice = q.type === 'multiple-choice';
            const userAnswer = userAnswers[currentQuestionIndex];
            const isLastQuestion = currentQuestionIndex === questions.length - 1;
            const isAnswered = isMultipleChoice ? userAnswer !== null : (userAnswer && userAnswer.trim() !== '');

            let answersHtml;
            if (isMultipleChoice) {
                answersHtml = `
                    <div style="margin-top: 1.5rem; display: flex; flex-direction: column; gap: 0.75rem;">
                        ${q.options.map((option, idx) => `
                            <button
                                data-answer="${option}"
                                class="quiz-option ${userAnswer === option ? 'selected' : ''}"
                            >
                                ${option}
                            </button>
                        `).join('')}
                    </div>
                `;
            } else {
                answersHtml = `
                    <textarea
                        id="textAnswer"
                        rows="4"
                        class="input-field"
                        style="margin-top: 1.5rem;"
                        placeholder="${q.type === 'identification' ? 'Type your answer here...' : 'List your items separated by commas...'}"
                    >${userAnswer || ''}</textarea>
                `;
            }

            mainElement.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                    <div class="quiz-header">
                        <p style="font-weight: 600; font-size: 1.125rem;">Question ${currentQuestionIndex + 1} of ${questions.length}</p>
                        <p class="quiz-type-tag">${q.type.replace('-', ' ')}</p>
                    </div>

                    <div class="quiz-question-box">
                        <p>${q.question}</p>
                    </div>

                    ${answersHtml}

                    <div class="quiz-nav">
                        <button
                            id="prevButton"
                            class="btn btn-secondary"
                            style="font-size: 0.875rem; padding: 0.5rem 1.5rem;"
                            ${currentQuestionIndex === 0 ? 'disabled' : ''}
                        >
                            ← Previous
                        </button>
                        
                        ${isLastQuestion ? `
                            <button
                                id="submitButton"
                                class="btn btn-success"
                                style="font-size: 0.875rem; padding: 0.5rem 1.5rem; ${isAnswered ? '' : 'background-color: #9ca3af;'}"
                                ${isAnswered ? '' : 'disabled'}
                            >
                                Submit Quiz
                            </button>
                        ` : `
                            <button
                                id="nextButton"
                                class="btn btn-primary"
                                style="font-size: 0.875rem; padding: 0.5rem 1.5rem; ${isAnswered ? '' : 'background-color: #fbcfe8;'}"
                                ${isAnswered ? '' : 'disabled'}
                            >
                                Next Question →
                            </button>
                        `}
                    </div>
                </div>
            `;
            
            // Attach quiz event listeners
            if (isMultipleChoice) {
                mainElement.querySelectorAll('.quiz-option').forEach(btn => {
                    btn.addEventListener('click', handleAnswerSelection);
                });
            } else {
                const textAnswer = document.getElementById('textAnswer');
                textAnswer.addEventListener('input', handleTextAnswerChange);
                
                // Logic to enable/disable button on text change
                textAnswer.addEventListener('input', () => {
                    const answerText = textAnswer.value;
                    const isAnswered = answerText && answerText.trim() !== '';
                    const nextBtn = document.getElementById('nextButton') || document.getElementById('submitButton');
                    
                    if (nextBtn) {
                         if (isAnswered) {
                            nextBtn.style.backgroundColor = isLastQuestion ? 'var(--success-color)' : 'var(--primary-pink)';
                            nextBtn.removeAttribute('disabled');
                        } else {
                            nextBtn.style.backgroundColor = isLastQuestion ? '#9ca3af' : '#fbcfe8';
                            nextBtn.setAttribute('disabled', 'disabled');
                        }
                    }
                });
            }

            document.getElementById('prevButton').addEventListener('click', handlePreviousQuestion);
            if (isLastQuestion) {
                document.getElementById('submitButton').addEventListener('click', handleSubmitQuiz);
            } else {
                document.getElementById('nextButton').addEventListener('click', handleNextQuestion);
            }
        }

        function renderResultsScreen() {
            const totalQuestions = questions.length;
            const percentage = ((score / totalQuestions) * 100).toFixed(0);

            const getCorrectness = (q, userAnswer) => {
                if (q.type === 'multiple-choice') {
                    return userAnswer === q.answer;
                }
                // Simple check for other types (case-insensitive, trim)
                return userAnswer?.toLowerCase().trim() === q.answer?.toLowerCase().trim();
            };
            
            mainElement.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 2rem;">
                    <div class="results-summary">
                        <h2 style="border-bottom: none; margin-bottom: 0;">Quiz Complete!</h2>
                        <p class="results-score">${score} / ${totalQuestions}</p>
                        <p style="font-size: 1.5rem; font-weight: 600; color: var(--primary-dark);">Your Score: ${percentage}%</p>
                    </div>

                    <!-- Gemini Feedback -->
                    <div class="feedback-box">
                        <h3>
                            <svg xmlns="http://www.w3.org/2000/svg" style="height: 1.5rem; width: 1.5rem; margin-right: 0.5rem; color: var(--primary-pink);" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                            </svg>
                            Gemini AI Feedback
                        </h3>
                        <p style="color: #4b5563; white-space: pre-wrap;">${feedback}</p>
                    </div>

                    <!-- Review Section -->
                    <h3 style="font-size: 1.875rem; font-weight: 800; color: var(--heading-color); border-bottom: 2px solid var(--primary-pink); padding-bottom: 0.5rem;">Review Your Answers</h3>
                    <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                        ${questions.map((q, index) => {
                            const isCorrect = getCorrectness(q, userAnswers[index]);
                            return `
                                <div class="review-item ${isCorrect ? 'correct' : 'incorrect'}">
                                    <p class="review-question">Q${index + 1}: ${q.question}</p>
                                    <p style="font-size: 0.875rem; font-weight: 500;">
                                        Your Answer: <span class="${isCorrect ? 'review-answer-correct' : 'review-answer-incorrect'}">
                                            ${userAnswers[index] || 'No Answer'}
                                        </span>
                                    </p>
                                    ${!isCorrect ? `
                                        <p style="font-size: 0.875rem; font-weight: 500; margin-top: 0.25rem;">
                                            Correct Answer: <span style="color: #065f46; font-weight: 700;">${q.answer}</span>
                                        </p>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div style="padding-top: 1rem;">
                        <button
                            id="newQuizButton"
                            class="btn btn-primary"
                            style="width: 100%;"
                        >
                            Create New Quiz
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('newQuizButton').addEventListener('click', handleNewQuiz);
        }

        // --- Event Handlers ---

        function handleTextChange(e) {
            fileContentText = e.target.value;
            // Clear file data if user starts typing manually
            fileDataBase64 = null; 
            fileMimeType = null;
            pdfFileName = '';

            document.getElementById('charCount').textContent = `${fileContentText.length} / 5000`;
            renderApp();
        }

        function handleFileChange(e) {
            const file = e.target.files[0];
            const uploadFileNameSpan = document.getElementById('uploadFileName');

            if (!file) {
                fileDataBase64 = null;
                fileMimeType = null;
                pdfFileName = '';
                uploadFileNameSpan.textContent = 'Choose File...';
                renderApp();
                return;
            }
            
            error = null;
            pdfFileName = file.name;
            uploadFileNameSpan.textContent = file.name;
            
            // Limit file size to 4MB (Gemini limit for inline data)
            const MAX_SIZE_MB = 4;
            if (file.size > MAX_SIZE_MB * 1024 * 1024) {
                error = `File size (${(file.size / (1024 * 1024)).toFixed(2)}MB) exceeds the ${MAX_SIZE_MB}MB limit for direct AI processing. Please use a smaller file or paste the text content manually.`;
                fileDataBase64 = null;
                fileMimeType = null;
                quizStatus = 'config';
                // Clear the file input element to allow re-selection
                e.target.value = null; 
                uploadFileNameSpan.textContent = 'Choose File...';
                renderApp();
                return;
            }
            
            fileMimeType = file.type || 'application/octet-stream';

            const reader = new FileReader();

            loadingMessage = `Reading and encoding file: ${file.name}...`;
            quizStatus = 'loading';
            renderApp();
            
            // Clear manual text if a file is uploaded
            fileContentText = '';
            
            reader.onload = (event) => {
                try {
                    // Convert ArrayBuffer to Base64 string (mimicking server-side encoding)
                    const base64String = btoa(
                        new Uint8Array(event.target.result)
                            .reduce((data, byte) => data + String.fromCharCode(byte), '')
                    );
                    
                    fileDataBase64 = base64String;
                    loadingMessage = '';
                    quizStatus = 'config';
                    error = null;
                } catch (err) {
                    console.error("Base64 encoding error:", err);
                    error = "Failed to encode file data. Try pasting the content manually.";
                    fileDataBase64 = null;
                    fileMimeType = null;
                    // Clear the file input element to allow re-selection
                    e.target.value = null;
                    uploadFileNameSpan.textContent = 'Choose File...';
                }
                renderApp(); 
            };

            reader.onerror = (error) => {
                console.error("File reading error:", error);
                error = `Failed to read file: ${error.message}.`;
                fileDataBase64 = null;
                fileMimeType = null;
                loadingMessage = '';
                quizStatus = 'config';
                e.target.value = null; 
                uploadFileNameSpan.textContent = 'Choose File...';
                renderApp();
            };
            
            // Read the file as binary ArrayBuffer
            reader.readAsArrayBuffer(file);
        }

        function handleConfigChange(e) {
            const { name, value } = e.target;
            quizConfig[name] = name === 'numQuestions' ? parseInt(value) : value;
        }

        async function handleGenerateQuiz() {
            // Check if generation button should be enabled based on current state
            const isContentReady = fileContentText.trim() || (fileDataBase64 && fileMimeType);

            if (!isContentReady) {
                error = "No content uploaded or pasted. Please provide study material.";
                renderApp();
                return;
            }
            
            error = null;
            loadingMessage = 'Generating questions and answers...';
            quizStatus = 'loading';
            renderApp();

            try {
                const generatedQuestions = await generateQuizContent();
                
                if (generatedQuestions.length === 0) {
                     throw new Error("AI did not return any questions. Please check your content and try again.");
                }

                questions = generatedQuestions;
                userAnswers = new Array(generatedQuestions.length).fill(null);
                currentQuestionIndex = 0;
                quizStatus = 'quiz';

            } catch (err) {
                console.error("Quiz generation error:", err);
                error = `Failed to generate quiz: ${err.message}. Please check console for details.`;
                quizStatus = 'config';
            } finally {
                loadingMessage = '';
                renderApp();
            }
        }

        function handleAnswerSelection(e) {
            const button = e.target.closest('.quiz-option');
            if (!button) return;

            const answer = button.dataset.answer;
            userAnswers[currentQuestionIndex] = answer;
            renderApp();
        }

        function handleTextAnswerChange(e) {
            userAnswers[currentQuestionIndex] = e.target.value;
            // No full render here, only button state updated via separate listener on render
        }

        function handleNextQuestion() {
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                renderApp();
            }
        }

        function handlePreviousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                renderApp();
            }
        }

        async function handleSubmitQuiz() {
            loadingMessage = 'Calculating score and generating personalized feedback...';
            quizStatus = 'loading';
            renderApp();
            
            // 1. Calculate Score
            let correctCount = 0;
            const totalQuestions = questions.length;
            const finalAnswers = [...userAnswers];

            questions.forEach((q, i) => {
                const ua = finalAnswers[i];
                let isCorrect = false;

                if (q.type === 'enumeration' || q.type === 'identification') {
                    // Case-insensitive, trim comparison for text inputs
                    isCorrect = ua?.toLowerCase().trim() === q.answer.toLowerCase().trim();
                } else {
                    // Strict comparison for multiple choice
                    isCorrect = ua === q.answer;
                }

                if (isCorrect) {
                    correctCount++;
                }
            });
            
            score = correctCount;
            
            // 2. Generate Feedback
            try {
                feedback = await generateFeedback(score, totalQuestions, finalAnswers);
            } catch (err) {
                console.error("Feedback generation error:", err);
                feedback = "Could not generate detailed AI feedback, but congratulations on finishing the quiz!";
            } finally {
                loadingMessage = '';
                quizStatus = 'results';
                renderApp();
            }
        }

        function handleNewQuiz() {
            quizStatus = 'config';
            questions = [];
            userAnswers = [];
            score = 0;
            feedback = '';
            fileContentText = '';
            fileDataBase64 = null;
            fileMimeType = null;
            pdfFileName = '';
            renderApp();
        }

        // --- Initialization ---

        function initApp() {
            // Set a local UUID for user identification
            userId = generateUUID();
            renderApp(); // Initial render of the config screen
        }

        window.addEventListener('load', initApp);
    </script>
</body>
</html>